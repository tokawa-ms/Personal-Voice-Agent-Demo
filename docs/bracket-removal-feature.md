# 括弧書き削除機能

## 概要

AI Agent Service からの応答に含まれる括弧書き（【】や（））を音声合成時に自動的に削除する機能です。

## 背景と目的

### 背景

AI Agent が応答を生成する際、以下のような情報を括弧書きで補足することがあります:

- 参照文献やファイル名: 【4:1†FY26 EPS Asia Tech Team Strategy Memo.pdf】
- 正式名称や追加説明: （ソフトウェア・デベロップメント・センター）
- 補足情報や注釈: (注: これは例です)

これらの情報は視覚的には有用ですが、音声で読み上げると以下の問題があります:

1. **冗長性**: 括弧内の長い情報（特にファイル名など）を読み上げると、聴取者にとって不要な情報が多い
2. **自然性の欠如**: 括弧書きを含む読み上げは人間の自然な会話パターンではない
3. **理解の妨げ**: 長い括弧内の情報により、本質的なメッセージが伝わりにくくなる

### 目的

この機能は以下を実現します:

1. **UIでの情報保持**: チャット画面では括弧書きを含む完全な情報を表示
2. **音声での最適化**: 音声合成時には括弧書きを削除し、より自然で簡潔な読み上げを実現
3. **ユーザーエクスペリエンスの向上**: 視覚と聴覚の両方で最適な情報提供を実現

## 機能仕様

### 削除対象の括弧

この機能は以下の種類の括弧を削除します:

| 括弧の種類 | 開始 | 終了 | 例 |
|-----------|------|------|-----|
| 全角角括弧 | 【 | 】 | 【参照文献】 |
| 全角丸括弧 | （ | ） | （補足説明） |
| 半角角括弧 | [ | ] | [reference] |
| 半角丸括弧 | ( | ) | (note) |

### 処理の流れ

```
AI Agent の応答受信
    ↓
┌──────────────────────────────┐
│ チャットUIへの表示            │ ← 括弧書き含む元のテキスト
└──────────────────────────────┘
    ↓
┌──────────────────────────────┐
│ 音声合成の準備                │
│  1. removeBracketedText()   │ ← 括弧書きを削除
│  2. escapeXml()             │ ← XMLエスケープ
│  3. SSML生成                │ ← Personal Voice用SSML
└──────────────────────────────┘
    ↓
Personal Voice で音声再生
```

### 処理ロジック

括弧書き削除は以下の順序で実行されます:

1. 全角角括弧【】内のテキストを削除
2. 全角丸括弧（）内のテキストを削除
3. 半角角括弧[]内のテキストを削除
4. 半角丸括弧()内のテキストを削除
5. 連続する空白を1つの空白に統一
6. 先頭と末尾の空白を削除

## 使用例

### 例1: 参照文献の削除

**元のテキスト**:
```
この情報は【4:1†FY26 EPS Asia Tech Team Strategy Memo.pdf】に記載されています。
```

**UIに表示**:
```
この情報は【4:1†FY26 EPS Asia Tech Team Strategy Memo.pdf】に記載されています。
```

**音声合成用テキスト**:
```
この情報はに記載されています。
```

**音声読み上げ**:
> 「この情報はに記載されています。」

---

### 例2: 補足説明の削除

**元のテキスト**:
```
開発センター（ソフトウェア・デベロップメント・センター）で作業しています。
```

**UIに表示**:
```
開発センター（ソフトウェア・デベロップメント・センター）で作業しています。
```

**音声合成用テキスト**:
```
開発センターで作業しています。
```

**音声読み上げ**:
> 「開発センターで作業しています。」

---

### 例3: 複数の括弧

**元のテキスト**:
```
プロジェクトは【Project Alpha】として開始され、現在は第2フェーズ（実装フェーズ）に入っています。
```

**UIに表示**:
```
プロジェクトは【Project Alpha】として開始され、現在は第2フェーズ（実装フェーズ）に入っています。
```

**音声合成用テキスト**:
```
プロジェクトはとして開始され、現在は第2フェーズに入っています。
```

**音声読み上げ**:
> 「プロジェクトはとして開始され、現在は第2フェーズに入っています。」

---

### 例4: 英語での使用

**元のテキスト**:
```
The document (see Appendix A) contains important information [reference needed].
```

**UIに表示**:
```
The document (see Appendix A) contains important information [reference needed].
```

**音声合成用テキスト**:
```
The document contains important information.
```

**音声読み上げ**:
> 「The document contains important information.」

## 技術実装

### 実装コード

```javascript
/**
 * 括弧書きを削除する関数
 * AI Agent Service の応答から括弧書き（【】や（））を削除して音声合成用のテキストを生成
 * @param {string} text - 元のテキスト
 * @returns {string} - 括弧書きを削除したテキスト
 */
function removeBracketedText(text) {
    if (!text) return '';
    
    console.log('Removing bracketed text from:', text);
    
    // 【】の中身を削除（全角角括弧）
    let cleanedText = text.replace(/【[^】]*】/g, '');
    
    // （）の中身を削除（全角丸括弧）
    cleanedText = cleanedText.replace(/（[^）]*）/g, '');
    
    // 半角括弧も念のため削除
    cleanedText = cleanedText.replace(/\[[^\]]*\]/g, '');
    cleanedText = cleanedText.replace(/\([^)]*\)/g, '');
    
    // 連続する空白を1つの空白に置換
    cleanedText = cleanedText.replace(/\s+/g, ' ').trim();
    
    console.log('Text after removing brackets:', cleanedText);
    
    return cleanedText;
}
```

### 正規表現の説明

| 正規表現 | 説明 |
|---------|------|
| `/【[^】]*】/g` | 【と】の間のすべての文字（】以外）を削除 |
| `/（[^）]*）/g` | （と）の間のすべての文字（）以外）を削除 |
| `/\[[^\]]*\]/g` | [と]の間のすべての文字（]以外）を削除 |
| `/\([^)]*\)/g` | (と)の間のすべての文字（)以外）を削除 |
| `/\s+/g` | 連続する空白文字を1つの空白に置換 |

### 統合ポイント

この関数は `synthesizeSpeech` 関数内で呼び出されます:

```javascript
async function synthesizeSpeech(text) {
    // ... 省略 ...
    
    // 括弧書きを削除してから音声合成用のテキストを生成
    const textWithoutBrackets = removeBracketedText(text);
    
    // テキストをXMLエスケープ
    const escapedText = escapeXml(textWithoutBrackets);
    
    // Personal Voice用のSSML生成
    const ssml = `
        <speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" 
               xmlns:mstts="http://www.w3.org/2001/mstts" xml:lang="${language}">
            <voice name="${voiceName}">
                <mstts:ttsembedding speakerProfileId="${speakerProfileId}">
                    ${escapedText}
                </mstts:ttsembedding>
            </voice>
        </speak>
    `;
    
    // ... 省略 ...
}
```

## デバッグとログ

### コンソールログ

この機能は詳細なコンソールログを出力します:

```javascript
// 入力テキスト
console.log('Removing bracketed text from:', text);

// 出力テキスト
console.log('Text after removing brackets:', cleanedText);
```

### デバッグ方法

1. ブラウザの開発者ツールを開く（F12）
2. コンソールタブを選択
3. AI Agent と会話し、応答に括弧書きが含まれるメッセージを送信
4. コンソールで以下のログを確認:
   - `Removing bracketed text from:` - 元のテキスト
   - `Text after removing brackets:` - 括弧削除後のテキスト
   - `SSML prepared for synthesis` - 音声合成の準備完了

## 制限事項と考慮事項

### 制限事項

1. **ネストされた括弧**: 現在の実装では、ネストされた括弧（例: 【外側【内側】】）には対応していません
2. **不完全な括弧**: 開始括弧のみ、または終了括弧のみの場合は削除されません
3. **括弧の組み合わせ**: 【と）のような異なる種類の括弧の組み合わせには対応していません

### 考慮事項

1. **文脈の変化**: 括弧を削除することで、文の意味が変わる可能性があります
   - 例: 「彼（山田さん）が来ました」→「彼が来ました」
   - この場合、文脈情報が失われる可能性があります

2. **数式や技術的な表現**: 数式や技術的な表現で括弧が重要な意味を持つ場合
   - 例: 「関数 f(x) を計算します」→「関数 f を計算します」
   - このようなケースでは、括弧を削除しない方が良い場合があります

3. **多言語対応**: 言語によって括弧の使用方法が異なる可能性があります

## 今後の改善案

1. **選択的削除**: 特定の種類の括弧のみを削除するオプション
2. **カスタマイズ**: ユーザーが削除する括弧の種類を選択できる設定画面
3. **ネスト対応**: ネストされた括弧にも対応
4. **スマート削除**: AIを使用して、削除しても文脈が保たれるかを判断
5. **統計情報**: 削除された括弧の統計をダッシュボードに表示

## トラブルシューティング

### 問題: 括弧が削除されない

**原因**: 
- 括弧の種類が対応していない可能性があります

**解決方法**:
1. コンソールログで入力テキストを確認
2. 使用されている括弧の種類を確認
3. 必要に応じて、`removeBracketedText` 関数に新しい正規表現を追加

### 問題: 削除されすぎる

**原因**:
- 通常の括弧も削除されている可能性があります

**解決方法**:
1. AI Agent のプロンプトを調整し、補足情報以外では括弧を使用しないようにする
2. または、特定の括弧タイプのみを削除するように関数を修正

### 問題: 音声が途切れる

**原因**:
- 括弧削除後のテキストが短くなりすぎている可能性があります

**解決方法**:
1. コンソールログで削除後のテキストを確認
2. AI Agent の応答を調整

## まとめ

この括弧書き削除機能により、Personal Voice Agent Demo はより自然で聴きやすい音声応答を実現できます。UIでは完全な情報を表示しつつ、音声では簡潔な読み上げを行うことで、ユーザーエクスペリエンスが向上します。

---

**機能実装日**: 2025-11-05  
**ドキュメント作成者**: GitHub Copilot Agent  
**バージョン**: 1.0.0
